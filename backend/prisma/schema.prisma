generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String            @id @default(uuid())
  whatsappNumber     String            @unique
  name               String?
  email              String?           @unique
  isActive           Boolean           @default(true)
  isAdmin            Boolean           @default(false)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  lastInteraction    DateTime          @default(now())
  conversationState  ConversationState @default(IDLE)
  
  // Relations
  criteria           PropertyCriteria?
  conversations      Conversation[]
  matches            Match[]
  notifications      Notification[]
  
  @@map("users")
}

model PropertyCriteria {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Property Type
  propertyType      PropertyType      @default(BOTH)
  
  // Price Range
  minPrice          Int?
  maxPrice          Int?
  
  // Surface
  minSurface        Int?
  maxSurface        Int?
  
  // Rooms
  minRooms          Int?
  maxRooms          Int?
  
  // Location
  locations         String[]          // Array of city/quartier names
  
  // Additional criteria
  furnished         Boolean?
  urgent            Boolean           @default(false)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@map("property_criteria")
}

model ScrapedListing {
  id                String   @id @default(uuid())
  source            Source   @default(FACEBOOK)
  
  // Source metadata
  groupId           String?
  groupName         String?
  postId            String   @unique
  postUrl           String?
  authorName        String?
  authorId          String?
  
  // Content
  originalText      String   @db.Text
  extractedData     Json?    // Structured data extracted by AI
  
  // AI Enrichment
  aiEnriched        Boolean  @default(false)
  confidenceScore   Float    @default(0)
  
  // Extracted fields (denormalized for performance)
  title             String?
  price             Int?
  location          String?
  surface           Int?
  rooms             Int?
  propertyType      PropertyType?
  contact           String?
  images            String[]
  furnished         Boolean?
  description       String?  @db.Text
  
  // Status
  isValid           Boolean  @default(true)
  isSent            Boolean  @default(false)
  sentToUsers       String[] // Array of whatsapp numbers
  
  // Timestamps
  postedAt          DateTime?
  scrapedAt         DateTime @default(now())
  
  // Relations
  matches           Match[]
  
  @@index([source])
  @@index([isValid])
  @@index([scrapedAt])
  @@index([price])
  @@index([location])
  @@map("scraped_listings")
}

model Conversation {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  direction         Direction // INCOMING or OUTGOING
  messageType       MessageType @default(TEXT)
  
  content           String   @db.Text
  mediaUrl          String?
  
  // Metadata
  isRead            Boolean  @default(false)
  isAiGenerated     Boolean  @default(false)
  
  // External IDs
  whatsappMessageId String?
  
  createdAt         DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@map("conversations")
}

model Match {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  listingId         String
  listing           ScrapedListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  // Matching score
  matchScore        Float    // 0-100
  matchReasons      String[] // Why it matched
  
  // Status
  isNotified        Boolean  @default(false)
  notifiedAt        DateTime?
  isViewed          Boolean  @default(false)
  viewedAt          DateTime?
  isInterested      Boolean?
  
  createdAt         DateTime @default(now())
  
  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
  @@map("matches")
}

model Notification {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type              NotificationType
  title             String
  message           String   @db.Text
  
  // Status
  isRead            Boolean  @default(false)
  readAt            DateTime?
  
  // Related entities
  relatedEntityId   String?
  relatedEntityType String?
  
  createdAt         DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model FacebookGroup {
  id                String   @id @default(uuid())
  groupId           String   @unique
  name              String
  description       String?
  
  // Configuration
  keywords          String[] // Keywords to filter posts
  isActive          Boolean  @default(true)
  priority          Int      @default(0) // Higher = more important
  
  // Stats
  lastScrapedAt     DateTime?
  totalPosts        Int      @default(0)
  validPosts        Int      @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("facebook_groups")
}

model SystemConfig {
  id                String   @id @default(uuid())
  key               String   @unique
  value             Json
  description       String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("system_config")
}

model ActivityLog {
  id                String   @id @default(uuid())
  action            String
  entityType        String
  entityId          String?
  userId            String?
  metadata          Json?
  
  createdAt         DateTime @default(now())
  
  @@index([createdAt])
  @@index([action])
  @@index([entityType])
  @@map("activity_logs")
}

// Enums
enum ConversationState {
  IDLE
  COLLECTING_CRITERIA
  CONFIRMING
  ACTIVE
  PAUSED
}

enum PropertyType {
  HOUSE
  APARTMENT
  BOTH
}

enum Source {
  FACEBOOK
  OTHER
}

enum Direction {
  INCOMING
  OUTGOING
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  DOCUMENT
  TEMPLATE
  BUTTON
}

enum NotificationType {
  LISTING_MATCH
  SYSTEM
  ADMIN
  ERROR
}
